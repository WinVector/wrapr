<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Vignette • wrapr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Debug Vignette">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wrapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CornerCases.html">Corner Cases</a>
    </li>
    <li>
      <a href="../articles/DebugFnW.html">Debug Vignette</a>
    </li>
    <li>
      <a href="../articles/FrameTools.html">Frame Tools</a>
    </li>
    <li>
      <a href="../articles/Function_Objects.html">Function Objects</a>
    </li>
    <li>
      <a href="../articles/Named_Arguments.html">Named Arguments</a>
    </li>
    <li>
      <a href="../articles/QuotingConcatinate.html">Quoting Concatinate</a>
    </li>
    <li>
      <a href="../articles/SubstitutionModes.html">Substitution Modes</a>
    </li>
    <li>
      <a href="../articles/bquote.html">bquote</a>
    </li>
    <li>
      <a href="../articles/dot_pipe.html">Dot Pipe</a>
    </li>
    <li>
      <a href="../articles/lambda.html">lambda Function Builder</a>
    </li>
    <li>
      <a href="../articles/let.html">Let</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/wrapr_applicable.html">wrapr_applicable</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Debug Vignette</h1>
                        <h4 class="author">John Mount, Nina Zumel</h4>
            
            <h4 class="date">2019-09-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/wrapr/blob/master/vignettes/DebugFnW.Rmd"><code>vignettes/DebugFnW.Rmd</code></a></small>
      <div class="hidden name"><code>DebugFnW.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates debugging a user-created function with the <code>DebugFnW</code> call. For our example, we will use a simple function that takes an argument <code>i</code> and returns the <code>i</code>th index of a ten-element vector:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># load package</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"wrapr"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># user function</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">f &lt;-<span class="st"> </span><span class="cf">function</span>(i) { (<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)[[i]] }</a></code></pre></div>
<p>Let’s imagine that we are calling this function deep within another process; perhaps we are calling it repeatedly, on a long sequence of (possibly unknown to us) inputs.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">inputs =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">9</span>,<span class="dv">0</span>,<span class="dv">8</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="cf">for</span>(x <span class="cf">in</span> inputs) {</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">     <span class="kw">f</span>(x)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  },</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="dt">error =</span> <span class="cf">function</span>(e) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(e) })</a></code></pre></div>
<pre><code>## &lt;simpleError in (1:10)[[i]]: attempt to select less than one element in get1index &lt;real&gt;&gt;</code></pre>
<p>Oops! We’ve crashed, and if this loop were deep in another process, we wouldn’t know why, or where. If we suspect that the function <code>f</code> is the cause, then we can wrap <code>f</code> using <code>wrapr:DebugFn</code>.</p>
<p><code><a href="../reference/DebugFnW.html">DebugFnW(saveDest, fn)</a></code> wraps its function argument <code>fn</code>, captures any arguments that cause it to fail, and saved those arguments and other state to a specified destination <code>saveDest</code>.</p>
<p>The state data is written to:</p>
<ul>
<li>a random temp file (if <code>saveDest</code> is null)</li>
<li>a user chosen file (if <code>saveDest</code> is character)</li>
<li>a <code><a href="https://www.rdocumentation.org/packages/base/topics/environment">globalenv()</a></code> variable (if <code>saveDest</code> is a name, as produced by <code><a href="https://www.rdocumentation.org/packages/base/topics/name">as.name()</a></code> or <code><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote()</a></code>)</li>
<li>passed to a user function (if <code>saveDest</code> is a function).</li>
</ul>
<p>Here, we wrap <code>f</code> and save error state into the global variable <code>lastError</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># wrap function with writeBack</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/DebugFnW.html">DebugFnW</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/name">as.name</a></span>(<span class="st">'lastError'</span>), f)</a></code></pre></div>
<p>Now we run the same loop as above, with the wrapped function <code>df</code> (note that the <code>tryCatch</code> is not strictly needed, this is just for running this example in a vignette).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># capture error (Note: tryCatch not needed for user code!)</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="cf">for</span>(x <span class="cf">in</span> inputs) {</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">     <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Fdist">df</a></span>(x)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  },</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="dt">error =</span> <span class="cf">function</span>(e) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(e) })</a></code></pre></div>
<pre><code>## &lt;simpleError in value[[3L]](cond): wrapr::DebugFnW: wrote error to globalenv() variable 'lastError'
##  You can reproduce the error with:
##  'do.call(p$fn, p$args)' (replace 'p' with actual variable name)&gt;</code></pre>
<p>We can then examine the error. Note in particular that <code>lastError$fn_name</code> records the name of the function that crashed, and <code>lastError$args</code> records the arguments that the function was called with. Also in these examples we are wrapping our code with a <code>tryCatch</code> block to capture exceptions; this is only to allow the <code>knitr</code> sheet to continue and <em>not</em> needed to use the debugging wrappers effectively.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># examine error</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(lastError)</a></code></pre></div>
<pre><code>## List of 4
##  $ fn       :function (i)  
##   ..- attr(*, "srcref")= 'srcref' int [1:8] 5 6 5 32 6 32 5 5
##   .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' &lt;environment: 0x7fd420c39bb8&gt; 
##  $ args     :List of 1
##   ..$ : num 0
##  $ namedargs: language df(x)
##  $ fn_name  : chr "f"</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">lastError<span class="op">$</span>args</a></code></pre></div>
<pre><code>## [[1]]
## [1] 0</code></pre>
<p>In many situations, just knowing the arguments is enough information (“Oops, we tried to index the vector from zero!”). In more complicated cases, we can set a debug point on the offending function, and then call it again with the failing arguments in order to track down the bug.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># redo call, perhaps debugging</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/do.call">do.call</a></span>(lastError<span class="op">$</span>fn_name, lastError<span class="op">$</span>args),</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">error =</span> <span class="cf">function</span>(e) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(e) })</a></code></pre></div>
<pre><code>## &lt;simpleError in (1:10)[[i]]: attempt to select less than one element in get1index &lt;real&gt;&gt;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># clean up</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rm">rm</a></span>(<span class="dt">list=</span><span class="st">'lastError'</span>)</a></code></pre></div>
<p>In many cases you may prefer to save the failing state into an external file rather than into the current runtime environment. Below we show example code for saving state to an RDS file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">saveDest &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/tempfile">tempfile</a></span>(<span class="st">'debug'</span>),<span class="st">'.RDS'</span>)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co"># wrap function with saveDeest</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/DebugFnW.html">DebugFnW</a></span>(saveDest,f)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co"># capture error (Note: tryCatch not needed for user code!)</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="cf">for</span>(x <span class="cf">in</span> inputs) {</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Fdist">df</a></span>(x)</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  },</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="dt">error =</span> <span class="cf">function</span>(e) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(e) })</a></code></pre></div>
<p>We can later read that file back into R, for debugging.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># load data</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">lastError &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(saveDest)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># examine error</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(lastError)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># redo call, perhaps debugging</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/do.call">do.call</a></span>(lastError<span class="op">$</span>fn_name, lastError<span class="op">$</span>args),</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="dt">error =</span> <span class="cf">function</span>(e) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(e) })</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># clean up</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.remove</a></span>(saveDest)</a></code></pre></div>
<p>For more practice, please view <a href="https://youtu.be/zFEC9-1XSN8?list=PLAKBwakacHbQT51nPHex1on3YNCCmggZA">our video on wrapper debugging</a>.</p>
<p>Note: <code>wrapr</code> debug functionality rehashes some of the capabilities of <code>dump.frames</code> (see <code><a href="https://www.rdocumentation.org/packages/utils/topics/help">help(dump.frames)</a></code>). Roughly <code>dump.frames</code> catches the exception (so trying to step or continue re-throws, and arguments may have moved from their starting values) and <code>wrapr</code> catches the call causing the exception in a state <em>prior</em> to starting the calculation (so arguments should be at their starting values). We have found some cases where <code>wrapr</code> is a bit more convenient in how it interacts with the <code>RStudio</code> visual debugger (please see this <a href="https://youtu.be/2NCj4Hacm8E?list=PLAKBwakacHbQT51nPHex1on3YNCCmggZA">screencast</a> for some comparison). Also, please see <a href="http://www.win-vector.com/blog/2012/10/error-handling-in-r/">this article</a> for use of <code>tryCatch</code> and <code>withRestarts</code>.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>

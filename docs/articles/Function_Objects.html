<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Function Objects • wrapr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Function Objects">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wrapr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CornerCases.html">Corner Cases</a>
    </li>
    <li>
      <a href="../articles/DebugFnW.html">Debug Vignette</a>
    </li>
    <li>
      <a href="../articles/FrameTools.html">Frame Tools</a>
    </li>
    <li>
      <a href="../articles/Function_Objects.html">Function Objects</a>
    </li>
    <li>
      <a href="../articles/Named_Arguments.html">Named Arguments</a>
    </li>
    <li>
      <a href="../articles/QuotingConcatinate.html">Quoting Concatinate</a>
    </li>
    <li>
      <a href="../articles/SubstitutionModes.html">Substitution Modes</a>
    </li>
    <li>
      <a href="../articles/dot_pipe.html">Dot Pipe</a>
    </li>
    <li>
      <a href="../articles/lambda.html">lambda Function Builder</a>
    </li>
    <li>
      <a href="../articles/let.html">Let</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/wrapr_applicable.html">wrapr_applicable</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Function Objects</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2018-12-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/wrapr/blob/master/vignettes/Function_Objects.Rmd"><code>vignettes/Function_Objects.Rmd</code></a></small>
      <div class="hidden name"><code>Function_Objects.Rmd</code></div>

    </div>

    
    
<p>The <a href="https://github.com/WinVector/wrapr"><code>wrapr</code></a> <a href="https://winvector.github.io/wrapr/reference/dot_arrow.html">dot arrow pipe</a> includes a detailed <code>S3</code>/<code>S4</code> configurable interface (detailed in the RJournal <a href="https://journal.r-project.org/archive/2018/RJ-2018-042/index.html">here</a>). The primary purpose of these pipe interfaces is to be able to treat objects as functions: i.e. to be able to pipe data into objects.</p>
<p>That is: <a href="https://winvector.github.io/wrapr/articles/dot_pipe.html">pipe notation</a> wants a world data transforms are single argument functions (with other parameters already bound in), and the <code>UnaryFn</code> derived classes we discuss here help realize such a world.</p>
<p>This can be made clearer with an example using some additional helper classes.</p>
<p>Suppose we wish to build a linear model as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))
model &lt;-<span class="st"> </span><span class="kw">lm</span>(y<span class="op">~</span>x, <span class="dt">data=</span> d)</code></pre></div>
<p>It is then natural to want to apply this model later to new data. This can be done as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>)
<span class="kw">predict</span>(model, <span class="dt">newdata =</span> d2)</code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>The <code>wrapr</code> package allows us to use a “piping into a function” notation as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"wrapr"</span>)

model_f &lt;-<span class="st"> </span><span class="cf">function</span>(df) {
  <span class="kw">predict</span>(model, <span class="dt">newdata =</span> df)
}

d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_f</code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>In the above example the <code>model</code> contents are captured in the function closure. However, it would be much more useful to store the model in an object.</p>
<p><code>wrapr</code> supplies a method to do this, which we will now demonstrate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model_o &lt;-<span class="st">  </span><span class="kw"><a href="../reference/pkgfn.html">pkgfn</a></span>(<span class="st">"stats::predict.lm"</span>,
                  <span class="dt">arg_name =</span> <span class="st">"newdata"</span>, 
                  <span class="dt">args =</span> <span class="kw">list</span>(<span class="dt">object =</span> model))

<span class="kw">print</span>(model_o)</code></pre></div>
<pre><code>## [1] "stats::predict.lm(newdata=., object)"</code></pre>
<p>Notice <code>model_o</code> is an object (not a function). However we can pipe into <code>model_o</code> as if it were an object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_o</code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>This works because <code>model_o</code> is derived from the <code>S4</code> class <code>UnaryFn</code> and <code>wrapr</code> has definitions for <code>apply_right.UnaryFn</code> and <code>apply_left.UnaryFn</code>, which integrate this class into the <a href="https://winvector.github.io/wrapr/reference/dot_arrow.html"><code>wrapr</code> dot-arrow pipe</a>. The family of <code>UnaryFn</code> classes single argument functions. This system happens to be implemented by <code>wrapr</code>, but <code>wrapr</code> dot arrow extension mechanisms also allow users to build their own pipe-compatible systems. (<code>S3</code>/<code>S4</code> extension details can be found in the RJournal <a href="https://journal.r-project.org/archive/2018/RJ-2018-042/index.html">here</a>.</p>
<p>The pipe notation is not strictly required as the apply is done through the <code>S4</code> method <code><a href="../reference/ApplyTo.html">wrapr::ApplyTo()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/ApplyTo.html">ApplyTo</a></span>(model_o, d2) </code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>However, the pipe notation is particularly convenient. This is especially true when we have a list of operations we wish to share (which we will demonstrate later in this note).</p>
<p>The above could all have been defined in user code (the <code>wrapr</code> pipe allows external extension), but as a convenience it is now supplied with of <code>wrapr</code> itself.</p>
<p>The above methods can be used to wrap functions such as <a href="https://winvector.github.io/vtreat/reference/prepare.html"><code><a href="http://www.rdocumentation.org/packages/vtreat/topics/prepare">vtreat::prepare()</a></code></a> to create very powerful data processing pipelines. A more involved example of trying this technique can be found <a href="https://github.com/WinVector/vtreat/blob/master/extras/ModelingPipelines.html">here</a>.</p>
<p>Note: the <code>wrapr</code> right-dispatch we are using is only triggered when the right-hand side of a pipeline is a symbol or name. This is consistent with pipelines such as “<code>5 %.&gt;% sin</code>” where we are not so much piping into the sin-function, but into a name that refers to the sin-function. However, piping into names covers almost every practical case.</p>
<p>Many function object steps can be captured by piping them together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">exp_step &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pkgfn.html">pkgfn</a></span>(<span class="st">"base::exp"</span>,
                  <span class="dt">arg_name =</span> <span class="st">"x"</span>)

<span class="co"># pipe line version</span>
d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_o <span class="op">%.&gt;%</span><span class="st"> </span>exp_step</code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The sequence of piped function objects is easier to share as a list, and we supply a list-type that can be piped into.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">steps &lt;-<span class="st"> </span>model_o <span class="op">%.&gt;%</span><span class="st"> </span>exp_step

d2 <span class="op">%.&gt;%</span><span class="st"> </span>steps</code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The idea is: <code>steps</code> stores an arbitrary number of function objects as a simple list, which itself declares itself as function object. Steps are executed left to right as one would expect in pipeline notation. These functions objects are small and simple. In particular the do not capture environments as function closures do (though obviously any function in them does have its own closure). This list of function objects can be easier to work with, store, and share than function closures or pipelines.</p>
<p>Again, the pipe notation is not required (but is a nice notation). The apply a list of function objects effect can be achieved directly with <code><a href="../reference/ApplyTo.html">wrapr::ApplyTo()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/ApplyTo.html">ApplyTo</a></span>(steps, d2)</code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The idea is: sharing a list of function object steps frees any downstream users of the pipeline from having to know how many steps or in the pipeline. What we are trying to do with this set of features is share processing specifications as data, without having to share <code>R</code> code our function closures (which are heavier weight, and a bit more delicate).</p>
<p>We can look at the <code>steps</code> and the list items:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cat</span>(<span class="kw">format</span>(steps))</code></pre></div>
<pre><code>## UnaryFnList(
##    stats::predict.lm(newdata=., object),
##    base::exp(x=., ))</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">steps<span class="op">@</span>items</code></pre></div>
<pre><code>## [[1]]
## [1] "stats::predict.lm(newdata=., object)"
## 
## [[2]]
## [1] "base::exp(x=., )"</code></pre>
<p>And we can build such composite pipelines directly, without using <code><a href="../reference/ApplyTo.html">ApplyTo()</a></code> or pipes using the <code><a href="../reference/fnlist.html">fnlist()</a></code> method.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fnlist.html">fnlist</a></span>(model_o, exp_step)
<span class="kw">cat</span>(<span class="kw">format</span>(s2))</code></pre></div>
<pre><code>## UnaryFnList(
##    stats::predict.lm(newdata=., object),
##    base::exp(x=., ))</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d2 <span class="op">%.&gt;%</span><span class="st"> </span>s2</code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The <code>steps</code> object is a <code>UnaryFnList</code> <code>S4</code> class instance. This class’s purpose is to implement the <code>UnaryFn</code> interface (essentially be compatible with <code><a href="../reference/ApplyTo.html">ApplyTo()</a></code>) and carry a list of steps in its <code>@items</code> slot. The idea is this object is convenient to serialize and to pipe into.</p>
<p>In addition to the <code>PartialNamedFn</code> class we suggest looking at the following additional adapters:</p>
<ul>
<li>
<code><a href="../reference/srcfn.html">srcfn()</a></code> which accepts the source code for an arbitrary expression.</li>
<li>
<code><a href="../reference/wrapfn.html">wrapfn()</a></code> class which directly accepts a function (including the closure).</li>
</ul>
<p>Examples include:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s4 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/srcfn.html">srcfn</a></span>(<span class="st">". + y"</span>, <span class="dt">arg_name =</span> <span class="st">"."</span>, <span class="dt">args=</span> <span class="kw">list</span>(<span class="dt">y=</span><span class="dv">13</span>))
<span class="kw">print</span>(s4)</code></pre></div>
<pre><code>## [1] "SrcFunction{ . + y }(.=., y)"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">22</span> <span class="op">%.&gt;%</span><span class="st"> </span>s4</code></pre></div>
<pre><code>## [1] 35</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s5 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/wrapfn.html">wrapfn</a></span>(tan, <span class="dt">arg_name =</span> <span class="st">"x"</span>)
<span class="kw">print</span>(s5)</code></pre></div>
<pre><code>## [1] "PartialFunction{tan}(x=., )"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="dv">1</span><span class="op">:</span><span class="dv">4</span> <span class="op">%.&gt;%</span><span class="st"> </span>s5</code></pre></div>
<pre><code>## [1]  1.5574077 -2.1850399 -0.1425465  1.1578213</code></pre>
<p>The demonstrated design and functionality is inspired by partially applied functions, but a bit more circumspect in what is carried around. In Lisp “code is data”, in <code>R</code> it is a bit more complicated- so a pure-data solution has some merits.</p>
<p>And that the basics of <code>wrapr</code> function objects. For a more substantial data processing example please see <a href="https://github.com/WinVector/vtreat/blob/master/extras/ModelingPipelines.html">here</a>.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Function Objects • wrapr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Function Objects">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wrapr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.7.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CornerCases.html">Corner Cases</a>
    </li>
    <li>
      <a href="../articles/DebugFnW.html">Debug Vignette</a>
    </li>
    <li>
      <a href="../articles/FrameTools.html">Frame Tools</a>
    </li>
    <li>
      <a href="../articles/Function_Objects.html">Function Objects</a>
    </li>
    <li>
      <a href="../articles/Named_Arguments.html">Named Arguments</a>
    </li>
    <li>
      <a href="../articles/QuotingConcatinate.html">Quoting Concatinate</a>
    </li>
    <li>
      <a href="../articles/SubstitutionModes.html">Substitution Modes</a>
    </li>
    <li>
      <a href="../articles/dot_pipe.html">Dot Pipe</a>
    </li>
    <li>
      <a href="../articles/lambda.html">lambda Function Builder</a>
    </li>
    <li>
      <a href="../articles/let.html">Let</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/wrapr_applicable.html">wrapr_applicable</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Function Objects</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2018-11-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/wrapr/blob/master/vignettes/Function_Objects.Rmd"><code>vignettes/Function_Objects.Rmd</code></a></small>
      <div class="hidden name"><code>Function_Objects.Rmd</code></div>

    </div>

    
    
<p>The <a href="https://github.com/WinVector/wrapr"><code>wrapr</code></a> <a href="https://winvector.github.io/wrapr/reference/dot_arrow.html">dot arrow pipe</a> includes a detailed <code>S3</code>/<code>S4</code> configurable interface (detailed in the RJournal <a href="https://journal.r-project.org/archive/2018/RJ-2018-042/index.html">here</a>). The primary purpose of these interfaces is to be able to treat objects as functions: i.e. to be able to pipe data into objects.</p>
<p>This can be made clearer with an example using some helper functions.</p>
<p>Suppose we wish to build a linear model as follows.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">model &lt;-<span class="st"> </span><span class="kw">lm</span>(y<span class="op">~</span>x, <span class="dt">data=</span> d)</a></code></pre></div>
<p>It is then natural to want to apply this model later to new data. This can be done as follows.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">d2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">predict</span>(model, <span class="dt">newdata =</span> d2)</a></code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>The <code>wrapr</code> package allows us to use a “piping into a function” notation as follows.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"wrapr"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">model_f &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="kw">predict</span>(model, <span class="dt">newdata =</span> df)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_f</a></code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>In the above example the <code>model</code> contents are captured in the function closure. However, it would be much more useful to store the model in an object.</p>
<p><code>wrapr</code> supplies a method to do this, which we will now demonstrate.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">model_o &lt;-<span class="st"> </span><span class="kw"><a href="../reference/wrap_fname_S3.html">wrap_fname_S3</a></span>(<span class="st">'predict.lm'</span>,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                         <span class="dt">fn_package =</span> <span class="st">"stats"</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                         <span class="dt">arg_name =</span> <span class="st">"newdata"</span>, </a>
<a class="sourceLine" id="cb6-4" data-line-number="4">                         <span class="dt">args =</span> <span class="kw">list</span>(<span class="dt">object =</span> model))</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw">print</span>(model_o)</a></code></pre></div>
<pre><code>## $fn_name
## [1] "predict.lm"
## 
## $fn_package
## [1] "stats"
## 
## $args
## $args$object
## 
## Call:
## lm(formula = y ~ x, data = d)
## 
## Coefficients:
## (Intercept)            x  
##         0.7          0.3  
## 
## 
## 
## attr(,"class")
## [1] "wrapr_funobj_S3"</code></pre>
<p>Notice <code>model_o</code> is an object (not a function). However we can pipe into <code>model_o</code> as if it were an object.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_o</a></code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>This works because <code>model_o</code> declares <code>S3</code> class <code>wrapr_funobj_S3</code>. And <code>wrapr</code> defines a <code>S3</code> function named <code><a href="../reference/apply_right.wrapr_funobj_S3.html">apply_right.wrapr_funobj_S3()</a></code>, meaning <code>wrapr</code>’s pipe-method <code>apply_right</code> has a special definition for this class (the definition being: apply <code><a href="http://www.rdocumentation.org/packages/stats/topics/predict.lm">stats::predict.lm</a></code> to the piped in argument plus the arguments stored in <code>args</code>, supplied by the function <code><a href="../reference/applyto.html">wrapr::applyto()</a></code>). The <code>wrapr</code> design would allow these kinds of extensions to be defined by users or other packages, but for convenience <code>wrapr</code> is supplying on such extension itself (<code>S3</code>/<code>S4</code> extension details can be found in the RJournal <a href="https://journal.r-project.org/archive/2018/RJ-2018-042/index.html">here</a>).</p>
<p>The pipe notation is not strictly required as the apply is done through the function <a href="https://winvector.github.io/wrapr/reference/applyto.html"><code><a href="../reference/applyto.html">wrapr::applyto()</a></code></a>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/applyto.html">applyto</a></span>(model_o, d2) </a></code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>However, the pipe notation is particularly convenient. This is especially true when we have a list of operations we wish to share (which we will demonstrate later in this note).</p>
<p>The above could all have been defined in user code (the <code>wrapr</code> pipe allows external extension), but as a convenience it is now supplied with of <code>wrapr</code> itself.</p>
<p>The above methods can be used to wrap functions such as <a href="https://winvector.github.io/vtreat/reference/prepare.html"><code><a href="http://www.rdocumentation.org/packages/vtreat/topics/prepare">vtreat::prepare()</a></code></a> to create very powerful data processing pipelines.</p>
<p><code>wrapr</code> also has an easy to use <code>S4</code> interface. Using <code>S4</code> we can insist that our function is only dispatched if both the classes of the left and right pipe arguments are as expected. This is done as follows.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># define our right-class</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw"><a href="../reference/def_funobj_s4_class.html">def_funobj_s4_class</a></span>(<span class="st">"model_class"</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># ask wrapr to use partial function methods</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># on this pair of classes.</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw"><a href="../reference/set_funobj_s4_applyto.html">set_funobj_s4_applyto</a></span>(<span class="st">"data.frame"</span>, <span class="st">"model_class"</span>)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># build a new model wrapper of class "model_class"</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">m2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/wrap_fname_S4.html">wrap_fname_S4</a></span>(<span class="st">"model_class"</span>, </a>
<a class="sourceLine" id="cb12-10" data-line-number="10">                    <span class="st">'predict.lm'</span>, <span class="dt">fn_package =</span> <span class="st">"stats"</span>,</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">                    <span class="dt">arg_name =</span> <span class="st">"newdata"</span>, </a>
<a class="sourceLine" id="cb12-12" data-line-number="12">                    <span class="dt">args =</span> <span class="kw">list</span>(<span class="dt">object =</span> model))</a>
<a class="sourceLine" id="cb12-13" data-line-number="13"></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co"># now pipe into the new model representation.</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">d2 <span class="op">%.&gt;%</span><span class="st"> </span>m2</a></code></pre></div>
<pre><code>##   1   2   3   4   5 
## 1.6 1.9 2.2 2.5 2.8</code></pre>
<p>The <code>S4</code> forms are going to be a bit harder to share, as the objects depend on external items such as the <code>S4</code> class definition and application rules. So we recommend, in general, using the <code>S3</code> methods shown earlier.</p>
<p>All models that can accept a <code>data.frame</code> could share the same model class and apply-to definitions.</p>
<p>Note: the <code>wrapr</code> right-dispatch we are using is only triggered when the right-hand side of a pipeline is a symbol or name. This is consistent with pipelines such as “<code>5 %.&gt;% sin</code>” where we are not so much piping into the sin-function, but into a name that refers to the sin-function. However, piping into names covers almost every practical case.</p>
<p>Many function object steps can be captured in a list.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">exp_step &lt;-<span class="st"> </span><span class="kw"><a href="../reference/wrap_fname_S3.html">wrap_fname_S3</a></span>(<span class="st">'exp'</span>,</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">                          <span class="dt">arg_name =</span> <span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co"># pipe line version</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">d2 <span class="op">%.&gt;%</span><span class="st"> </span>model_o <span class="op">%.&gt;%</span><span class="st"> </span>exp_step</a></code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The sequence of piped function objects is easier to share as a list, and we supply a list-type that can be piped into.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">steps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pipe_list.html">pipe_list</a></span>(model_o, exp_step)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">d2 <span class="op">%.&gt;%</span><span class="st"> </span>steps</a></code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The idea is the <code>pipe_list</code> stores an arbitrary number of function objects as a simple list. We are calling objects of class <code>wrapr_funobj_S3</code> or classes from <code><a href="../reference/def_funobj_s4_class.html">def_funobj_s4_class()</a></code> “function objects”. These objects are small and simple (you can examine and serialize their content). This list of function objects is easier to work with than function closures or pipelines.</p>
<p>Again, the pipe notation is not required (but is a nice notation). The apply a list of function objects effect can be achieved directly with <code><a href="../reference/lapplyto.html">wrapr::lapplyto()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="../reference/lapplyto.html">lapplyto</a></span>(<span class="kw">list</span>(model_o, exp_step), d2)</a></code></pre></div>
<pre><code>##         1         2         3         4         5 
##  4.953032  6.685894  9.025013 12.182494 16.444647</code></pre>
<p>The idea is: sharing a list of function object steps frees any downstream users of the pipeline from having to know how many steps or in the pipeline. What we are trying to do with this set of features is share processing specifications as data, without having to share <code>R</code> code our function closures (which are heavier weight, and a bit more delicate). The functionality is inspired by partially applied functions, but a bit more circumspect in what is carried around. In Lisp “code is data”, in <code>R</code> it is a bit more complicated- so a pure-data solution has some merits.</p>
<p>And that is how to user <code>wrapr</code> to build powerful data processing pipelines.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>

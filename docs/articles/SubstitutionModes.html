<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Substitution Modes • wrapr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Substitution Modes">
<meta property="og:description" content="wrapr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wrapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CornerCases.html">Corner Cases</a>
    </li>
    <li>
      <a href="../articles/DebugFnW.html">Debug Vignette</a>
    </li>
    <li>
      <a href="../articles/FrameTools.html">Frame Tools</a>
    </li>
    <li>
      <a href="../articles/Named_Arguments.html">Named Arguments</a>
    </li>
    <li>
      <a href="../articles/QuotingConcatinate.html">Quoting Concatinate</a>
    </li>
    <li>
      <a href="../articles/SubstitutionModes.html">Substitution Modes</a>
    </li>
    <li>
      <a href="../articles/bquote.html">bquote</a>
    </li>
    <li>
      <a href="../articles/dot_pipe.html">Dot Pipe</a>
    </li>
    <li>
      <a href="../articles/lambda.html">lambda Function Builder</a>
    </li>
    <li>
      <a href="../articles/let.html">Let</a>
    </li>
    <li>
      <a href="../articles/multi_assign.html">Multiple Assignment</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/unpack_multiple_assignment.html">Multiple Assignment with unpack</a>
    </li>
    <li>
      <a href="../articles/wrapr_Eager.html">wrapr Eager Evaluation</a>
    </li>
    <li>
      <a href="../articles/wrapr_applicable.html">wrapr_applicable</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://win-vector.com">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SubstitutionModes_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Substitution Modes</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2020-09-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/wrapr/blob/master/vignettes/SubstitutionModes.Rmd"><code>vignettes/SubstitutionModes.Rmd</code></a></small>
      <div class="hidden name"><code>SubstitutionModes.Rmd</code></div>

    </div>

    
    
<div id="the-substitution-modes" class="section level2">
<h2 class="hasAnchor">
<a href="#the-substitution-modes" class="anchor"></a>The substitution modes</h2>
<p><code><a href="../reference/let.html">wrapr::let()</a></code> now has three substitution implementations:</p>
<ul>
<li>Language substitution (<code>subsMethod='langsubs'</code> the new default). In this mode user code is captured as an abstract syntax tree (or parse tree) and substitution is performed only on nodes known to be symbols or behaving in a symbol-role (<code>"X"</code> in <code>d$"X"</code> is one such example).</li>
<li>Substitute substitution (<code>subsMethod='subsubs'</code>). In this mode substitution is performed by <code>R</code>’s own <code><a href="#base/substitute.html">base::substitute()</a></code>.</li>
<li>String substitution (<code>subsMethod='stringsubs'</code>, the previous default now deprecated). In this mode user code is captured as text and then string replacement on word-boundaries is used to substitute in variable re-mappings.</li>
</ul>
<p>The semantics of the three methods can be illustrated by showing the effects of substituting the variable name “<code>y</code>” for “<code>X</code>” and the function “<code>sin</code>” for “<code>F</code>” in the somewhat complicated block of statements:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
  {
    <span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(<span class="st">"X"</span> = <span class="st">"X"</span>, X2 = <span class="st">"XX"</span>, d = <span class="kw">X</span><span class="op">*</span><span class="kw">X</span>, .X = <span class="kw">X_</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/list.html">list</a></span>(X = <span class="kw">d</span><span class="op">$</span><span class="kw">X</span>, X2 = <span class="kw">d</span><span class="op">$</span><span class="st">"X"</span>, v1 = <span class="kw">`X`</span>, v2 = <span class="kw">` X`</span>, <span class="fu"><a href="#base/logical.html">F</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>))
    <span class="kw">X</span><span class="op">$</span><span class="kw">a</span>
    <span class="st">"X"</span><span class="op">$</span><span class="kw">a</span>
    <span class="kw">X</span> <span class="op">=</span> <span class="fu">function</span>(<span class="kw">X</span>, <span class="kw">...</span>) { <span class="kw">X</span> <span class="op">+</span> <span class="fl">1</span> }
  }</pre></div>
<p>This block a lot of different examples and corner-cases.</p>
<div id="language-substitution-subsmethodlangsubs" class="section level4">
<h4 class="hasAnchor">
<a href="#language-substitution-subsmethodlangsubs" class="anchor"></a>Language substitution (<code>subsMethod='langsubs'</code>)</h4>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://github.com/WinVector/wrapr">"wrapr"</a></span>)

<span class="fu"><a href="../reference/let.html">let</a></span>(
  <span class="fu"><a href="#base/c.html">c</a></span>(X = <span class="st">'y'</span>, F = <span class="st">'sin'</span>), 
  {
    <span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(<span class="st">"X"</span> = <span class="st">"X"</span>, X2 = <span class="st">"XX"</span>, d = <span class="kw">X</span><span class="op">*</span><span class="kw">X</span>, .X = <span class="kw">X_</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/list.html">list</a></span>(X = <span class="kw">d</span><span class="op">$</span><span class="kw">X</span>, X2 = <span class="kw">d</span><span class="op">$</span><span class="st">"X"</span>, v1 = <span class="kw">`X`</span>, v2 = <span class="kw">` X`</span>, <span class="fu"><a href="#base/logical.html">F</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>))
    <span class="kw">X</span><span class="op">$</span><span class="kw">a</span>
    <span class="st">"X"</span><span class="op">$</span><span class="kw">a</span>
    <span class="kw">X</span> <span class="op">=</span> <span class="fu">function</span>(<span class="kw">X</span>, <span class="kw">...</span>) { <span class="kw">X</span> <span class="op">+</span> <span class="fl">1</span> }
  },
  eval = <span class="fl">FALSE</span>, subsMethod = <span class="st">'langsubs'</span>)</pre></div>
<pre><code>## {
##     d &lt;- data.frame(y = "X", X2 = "XX", d = y * y, .X = X_)
##     y &lt;- list(y = d$y, X2 = d$y, v1 = y, v2 = ` X`, sin(1:2))
##     y$a
##     "X"$a
##     y = function(y, ...) {
##         y + 1
##     }
## }</code></pre>
<p>Notice the substitution replaced all symbol-like uses of “<code>X</code>”, and only these (including correctly working with some that were quoted!).</p>
</div>
<div id="string-substitution-subsmethodstringsubs" class="section level4">
<h4 class="hasAnchor">
<a href="#string-substitution-subsmethodstringsubs" class="anchor"></a>String substitution (<code>subsMethod='stringsubs'</code>)</h4>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="../reference/let.html">let</a></span>(
  <span class="fu"><a href="#base/c.html">c</a></span>(X = <span class="st">'y'</span>, F = <span class="st">'sin'</span>), 
  {
    <span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(<span class="st">"X"</span> = <span class="st">"X"</span>, X2 = <span class="st">"XX"</span>, d = <span class="kw">X</span><span class="op">*</span><span class="kw">X</span>, .X = <span class="kw">X_</span>)
    <span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/list.html">list</a></span>(X = <span class="kw">d</span><span class="op">$</span><span class="kw">X</span>, X2 = <span class="kw">d</span><span class="op">$</span><span class="st">"X"</span>, v1 = <span class="kw">`X`</span>, v2 = <span class="kw">` X`</span>, <span class="fu"><a href="#base/logical.html">F</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>))
    <span class="kw">X</span><span class="op">$</span><span class="kw">a</span>
    <span class="st">"X"</span><span class="op">$</span><span class="kw">a</span>
    <span class="kw">X</span> <span class="op">=</span> <span class="fu">function</span>(<span class="kw">X</span>, <span class="kw">...</span>) { <span class="kw">X</span> <span class="op">+</span> <span class="fl">1</span> }
  },
  eval = <span class="fl">FALSE</span>, subsMethod = <span class="st">'stringsubs'</span>)</pre></div>
<pre><code>## expression({
##     d &lt;- data.frame(y = "y", X2 = "XX", d = y * y, .y = X_)
##     y &lt;- list(y = d$y, X2 = d$y, v1 = y, v2 = ` y`, sin(1:2))
##     y$a
##     "y"$a
##     y = function(y, ...) {
##         y + 1
##     }
## })</code></pre>
<p>Notice string substitution has a few flaws: it went after variable names that appeared to start with a word-boundary (the cases where the variable name started with a dot or a space). Substitution also occurred in some string constants (which as we have seen could be considered a good thing).</p>
<p>These situations are all avoidable as both the code inside the <code>let</code>-block and the substitution targets are chosen by the programmer, so they can be chosen to be simple and mutually consistent. We suggest “<code>ALL_CAPS</code>” style substitution targets as they jump out as being macro targets. But, of course, it is better to have stricter control on substitution.</p>
<p>Think of the language substitution implementation as a lower-bound on a perfect implementation (cautious, with a few corner cases to get coverage) and string substitution as an upper bound on a perfect implementation (aggressive, with a few over-reaches).</p>
</div>
<div id="substitute-substitution-subsmethodsubsubs" class="section level4">
<h4 class="hasAnchor">
<a href="#substitute-substitution-subsmethodsubsubs" class="anchor"></a>Substitute substitution (<code>subsMethod='subsubs'</code>)</h4>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="../reference/let.html">let</a></span>(<span class="fu"><a href="#base/c.html">c</a></span>(X = <span class="st">'y'</span>, F = <span class="st">'sin'</span>), 
    {
      <span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(<span class="st">"X"</span> = <span class="st">"X"</span>, X2 = <span class="st">"XX"</span>, d = <span class="kw">X</span><span class="op">*</span><span class="kw">X</span>, .X = <span class="kw">X_</span>)
      <span class="kw">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/list.html">list</a></span>(X = <span class="kw">d</span><span class="op">$</span><span class="kw">X</span>, X2 = <span class="kw">d</span><span class="op">$</span><span class="st">"X"</span>, v1 = <span class="kw">`X`</span>, v2 = <span class="kw">` X`</span>, <span class="fu"><a href="#base/logical.html">F</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>))
      <span class="kw">X</span><span class="op">$</span><span class="kw">a</span>
      <span class="st">"X"</span><span class="op">$</span><span class="kw">a</span>
      <span class="kw">X</span> <span class="op">=</span> <span class="fu">function</span>(<span class="kw">X</span>, <span class="kw">...</span>) { <span class="kw">X</span> <span class="op">+</span> <span class="fl">1</span> }
    },
    eval = <span class="fl">FALSE</span>, subsMethod = <span class="st">'subsubs'</span>)</pre></div>
<pre><code>## {
##     d &lt;- data.frame(X = "X", X2 = "XX", d = y * y, .X = X_)
##     y &lt;- list(X = d$y, X2 = d$X, v1 = y, v2 = ` X`, sin(1:2))
##     y$a
##     "X"$a
##     y = function(X, ...) {
##         y + 1
##     }
## }</code></pre>
<p>Notice <code><a href="#base/substitute.html">base::substitute()</a></code> doesn’t re-write left-hand-sides of argument bindings. This is why I originally didn’t consider using this implementation. Re-writing left-hand-sides of assignments is critical in expressions such as <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate( RESULTCOL = INPUTCOL + 1)</a></code>. Also <code><a href="#base/substitute.html">base::substitute()</a></code> doesn’t special case the <code>d$"X"</code> situation (but that really isn’t very important).</p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p><code><a href="../reference/let.html">wrapr::let()</a></code> when used prudently is a safe and powerful tool.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

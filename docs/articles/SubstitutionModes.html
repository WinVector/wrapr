<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Substitution Modes • wrapr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Substitution Modes">
<meta property="og:description" content="wrapr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wrapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CornerCases.html">Corner Cases</a>
    </li>
    <li>
      <a href="../articles/DebugFnW.html">Debug Vignette</a>
    </li>
    <li>
      <a href="../articles/FrameTools.html">Frame Tools</a>
    </li>
    <li>
      <a href="../articles/Named_Arguments.html">Named Arguments</a>
    </li>
    <li>
      <a href="../articles/QuotingConcatinate.html">Quoting Concatinate</a>
    </li>
    <li>
      <a href="../articles/SubstitutionModes.html">Substitution Modes</a>
    </li>
    <li>
      <a href="../articles/bquote.html">bquote</a>
    </li>
    <li>
      <a href="../articles/dot_pipe.html">Dot Pipe</a>
    </li>
    <li>
      <a href="../articles/lambda.html">lambda Function Builder</a>
    </li>
    <li>
      <a href="../articles/let.html">Let</a>
    </li>
    <li>
      <a href="../articles/multi_assign.html">Multiple Assignment</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/unpack_multiple_assignment.html">Multiple Assignment with unpack</a>
    </li>
    <li>
      <a href="../articles/wrapr_Eager.html">wrapr Eager Evaluation</a>
    </li>
    <li>
      <a href="../articles/wrapr_applicable.html">wrapr_applicable</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://win-vector.com" class="external-link">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Substitution Modes</h1>
                        <h4 data-toc-skip class="author">John Mount</h4>
            
            <h4 data-toc-skip class="date">2023-08-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/wrapr/blob/HEAD/vignettes/SubstitutionModes.Rmd" class="external-link"><code>vignettes/SubstitutionModes.Rmd</code></a></small>
      <div class="hidden name"><code>SubstitutionModes.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="the-substitution-modes">The substitution modes<a class="anchor" aria-label="anchor" href="#the-substitution-modes"></a>
</h2>
<p><code><a href="../reference/let.html">wrapr::let()</a></code> now has three substitution
implementations:</p>
<ul>
<li>Language substitution (<code>subsMethod='langsubs'</code> the new
default). In this mode user code is captured as an abstract syntax tree
(or parse tree) and substitution is performed only on nodes known to be
symbols or behaving in a symbol-role (<code>"X"</code> in
<code>d$"X"</code> is one such example).</li>
<li>Substitute substitution (<code>subsMethod='subsubs'</code>). In this
mode substitution is performed by <code>R</code>’s own
<code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">base::substitute()</a></code>.</li>
<li>String substitution (<code>subsMethod='stringsubs'</code>, the
previous default now deprecated). In this mode user code is captured as
text and then string replacement on word-boundaries is used to
substitute in variable re-mappings.</li>
</ul>
<p>The semantics of the three methods can be illustrated by showing the
effects of substituting the variable name “<code>y</code>” for
“<code>X</code>” and the function “<code>sin</code>” for
“<code>F</code>” in the somewhat complicated block of statements:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"X"</span> <span class="op">=</span> <span class="st">"X"</span>, X2 <span class="op">=</span> <span class="st">"XX"</span>, d <span class="op">=</span> <span class="va">X</span><span class="op">*</span><span class="va">X</span>, .X <span class="op">=</span> <span class="va">X_</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">X</span>, X2 <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="st">"X"</span>, v1 <span class="op">=</span> <span class="va">`X`</span>, v2 <span class="op">=</span> <span class="va">` X`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">F</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">X</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="st">"X"</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>This block a lot of different examples and corner-cases.</p>
<div class="section level4">
<h4 id="language-substitution-subsmethodlangsubs">Language substitution (<code>subsMethod='langsubs'</code>)<a class="anchor" aria-label="anchor" href="#language-substitution-subsmethodlangsubs"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/WinVector/wrapr" class="external-link">"wrapr"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/let.html">let</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="st">'y'</span>, F <span class="op">=</span> <span class="st">'sin'</span><span class="op">)</span>, </span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"X"</span> <span class="op">=</span> <span class="st">"X"</span>, X2 <span class="op">=</span> <span class="st">"XX"</span>, d <span class="op">=</span> <span class="va">X</span><span class="op">*</span><span class="va">X</span>, .X <span class="op">=</span> <span class="va">X_</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">X</span>, X2 <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="st">"X"</span>, v1 <span class="op">=</span> <span class="va">`X`</span>, v2 <span class="op">=</span> <span class="va">` X`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">F</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">X</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="st">"X"</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  eval <span class="op">=</span> <span class="cn">FALSE</span>, subsMethod <span class="op">=</span> <span class="st">'langsubs'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## {</span></span>
<span><span class="co">##     d &lt;- data.frame(y = "X", X2 = "XX", d = y * y, .X = X_)</span></span>
<span><span class="co">##     y &lt;- list(y = d$y, X2 = d$y, v1 = y, v2 = ` X`, sin(1:2))</span></span>
<span><span class="co">##     y$a</span></span>
<span><span class="co">##     "X"$a</span></span>
<span><span class="co">##     y = function(y, ...) {</span></span>
<span><span class="co">##         y + 1</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span></code></pre>
<p>Notice the substitution replaced all symbol-like uses of
“<code>X</code>”, and only these (including correctly working with some
that were quoted!).</p>
</div>
<div class="section level4">
<h4 id="string-substitution-subsmethodstringsubs">String substitution (<code>subsMethod='stringsubs'</code>)<a class="anchor" aria-label="anchor" href="#string-substitution-subsmethodstringsubs"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/let.html">let</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="st">'y'</span>, F <span class="op">=</span> <span class="st">'sin'</span><span class="op">)</span>, </span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"X"</span> <span class="op">=</span> <span class="st">"X"</span>, X2 <span class="op">=</span> <span class="st">"XX"</span>, d <span class="op">=</span> <span class="va">X</span><span class="op">*</span><span class="va">X</span>, .X <span class="op">=</span> <span class="va">X_</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">X</span>, X2 <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="st">"X"</span>, v1 <span class="op">=</span> <span class="va">`X`</span>, v2 <span class="op">=</span> <span class="va">` X`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">F</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">X</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="st">"X"</span><span class="op">$</span><span class="va">a</span></span>
<span>    <span class="va">X</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  eval <span class="op">=</span> <span class="cn">FALSE</span>, subsMethod <span class="op">=</span> <span class="st">'stringsubs'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## expression({</span></span>
<span><span class="co">##     d &lt;- data.frame(y = "y", X2 = "XX", d = y * y, .y = X_)</span></span>
<span><span class="co">##     y &lt;- list(y = d$y, X2 = d$y, v1 = y, v2 = ` y`, sin(1:2))</span></span>
<span><span class="co">##     y$a</span></span>
<span><span class="co">##     "y"$a</span></span>
<span><span class="co">##     y = function(y, ...) {</span></span>
<span><span class="co">##         y + 1</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## })</span></span></code></pre>
<p>Notice string substitution has a few flaws: it went after variable
names that appeared to start with a word-boundary (the cases where the
variable name started with a dot or a space). Substitution also occurred
in some string constants (which as we have seen could be considered a
good thing).</p>
<p>These situations are all avoidable as both the code inside the
<code>let</code>-block and the substitution targets are chosen by the
programmer, so they can be chosen to be simple and mutually consistent.
We suggest “<code>ALL_CAPS</code>” style substitution targets as they
jump out as being macro targets. But, of course, it is better to have
stricter control on substitution.</p>
<p>Think of the language substitution implementation as a lower-bound on
a perfect implementation (cautious, with a few corner cases to get
coverage) and string substitution as an upper bound on a perfect
implementation (aggressive, with a few over-reaches).</p>
</div>
<div class="section level4">
<h4 id="substitute-substitution-subsmethodsubsubs">Substitute substitution (<code>subsMethod='subsubs'</code>)<a class="anchor" aria-label="anchor" href="#substitute-substitution-subsmethodsubsubs"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/let.html">let</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>X <span class="op">=</span> <span class="st">'y'</span>, F <span class="op">=</span> <span class="st">'sin'</span><span class="op">)</span>, </span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"X"</span> <span class="op">=</span> <span class="st">"X"</span>, X2 <span class="op">=</span> <span class="st">"XX"</span>, d <span class="op">=</span> <span class="va">X</span><span class="op">*</span><span class="va">X</span>, .X <span class="op">=</span> <span class="va">X_</span><span class="op">)</span></span>
<span>      <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">X</span>, X2 <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="st">"X"</span>, v1 <span class="op">=</span> <span class="va">`X`</span>, v2 <span class="op">=</span> <span class="va">` X`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">F</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">X</span><span class="op">$</span><span class="va">a</span></span>
<span>      <span class="st">"X"</span><span class="op">$</span><span class="va">a</span></span>
<span>      <span class="va">X</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span>    eval <span class="op">=</span> <span class="cn">FALSE</span>, subsMethod <span class="op">=</span> <span class="st">'subsubs'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## {</span></span>
<span><span class="co">##     d &lt;- data.frame(X = "X", X2 = "XX", d = y * y, .X = X_)</span></span>
<span><span class="co">##     y &lt;- list(X = d$y, X2 = d$X, v1 = y, v2 = ` X`, sin(1:2))</span></span>
<span><span class="co">##     y$a</span></span>
<span><span class="co">##     "X"$a</span></span>
<span><span class="co">##     y = function(X, ...) {</span></span>
<span><span class="co">##         y + 1</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span></code></pre>
<p>Notice <code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">base::substitute()</a></code> doesn’t re-write
left-hand-sides of argument bindings. This is why I originally didn’t
consider using this implementation. Re-writing left-hand-sides of
assignments is critical in expressions such as
<code>dplyr::mutate( RESULTCOL = INPUTCOL + 1)</code>. Also
<code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">base::substitute()</a></code> doesn’t special case the
<code>d$"X"</code> situation (but that really isn’t very important).</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code><a href="../reference/let.html">wrapr::let()</a></code> when used prudently is a safe and powerful
tool.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
